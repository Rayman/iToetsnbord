<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
         "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>iPhone Navigation</title>
<meta name="viewport" content="width=320; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
<style type="text/css" media="screen">@import "iphonenav.css";</style>
<script type="application/x-javascript" src="scripts/mootools-1.2.4-core.js"></script>
<script type="application/x-javascript" src="scripts/iphonenav.js"></script>
<script type="application/x-javascript" src="scripts/itoetsnbord.js"></script>
<script type="application/x-javascript">

//Hold the JSON object with current song
var currentSongPlaying = null;

window.addEvent('domready', function() {

	//Init the song manager
	currentSongManager = new SongManager({
		getCurrentSongUrl: 'getcurrent.html',
		onUpdate: function(responseJSON){
			//Back it up
			currentSongPlaying = responseJSON;

			//Update the html
			$('currentAlbum').set('html', "Album: " + responseJSON.album);
			$('currentArtist').set('html', "Artist: " + responseJSON.artist);
			$('currentTitle').set('html', "Title: " + responseJSON.title);
			$('currentInfo').set(
				'html',
				"Info: " + responseJSON.bitrate + "kbps, " +
				responseJSON.samplerate + "kHz " +
				responseJSON.channels
			);
			$('currentAlbumArt').setProperty('src', responseJSON.albumart);
		},
	});

	//When user clicks this link, get the current song played
	$('getCurrent').addEvent('click', function(){
		// If we do addEvent('click',currentSongmanager.update), then 'this' gets set as 'window'
		currentSongManager.update();
	});

	//When the play controls are clicked, get the html page and update the current song
	$('playControls').getElements('a').each(function(el){
		el.addEvent('click', function(event){
			event.preventDefault();
			currentSongManager.update(el.get('href'));
		});
	});

	//Init the searcher
	searcher = new MusicSearcher({
		//The url for the searches
		getSearchResultsUrl: 'getsearchresults.html?query=',

		//When the request is complete
		onSearchComplete: function(responseJSON){
			//Empty the list (it has a spinner)
			$('searchList').empty();

			//Get a reference to this (searcher)
			var searcherRef = this;

			//When clicked on this link, it loads 30 more items in the list
			//After that, it moved itself to the end of the list
			var loadMoreLink = new Element('a',{
				'href': 'javascript:void(0)',
				'html': 'Load more...',
				'events':{
					'click': function(){
						//Get the todo Items
						var todo = this.retrieve('todoItems');
						//Inject the first 20
						todo.splice(0,30).each(function(item){
							searcherRef.formatSearchResult(item).inject('searchList');
						});

						//Remove the link
						var removedElement = this.getParent().dispose();
						if(todo.length>0)
						{
							//And inject it back in
							removedElement.inject('searchList');
							this.store('todoItems',todo);
						}
					}
				}
			});
			loadMoreLink.inject(new Element('li').inject('searchList'));
			loadMoreLink.store('todoItems',responseJSON);
			loadMoreLink.fireEvent('click');
		}
	});

	//Add listener for album searching
	$('currentAlbum').addEvent('click',function(){
		searcher.search('ALBUM HAS "'+currentSongPlaying.album+'"');
	});

	//Add listener for artist searching
	$('currentArtist').addEvent('click',function(){
		searcher.search('ARTIST HAS "'+currentSongPlaying.artist+'"');
	});

	//Add listener for search form submit
	$('searchForm').addEvent('submit',function(e){
		var artist = this.getElement('input[name=artist]').value;
		var song   = this.getElement('input[name=song]').value;
		artist = artist == '' ? '' : 'ARTIST HAS "' + artist +'"';
		song   = song   == '' ? '' : 'TITLE HAS  "' + song   +'"';
		query = (song != '' && artist != '') ? song + ' && ' + artist : song + artist;
		searcher.search(query);
	});
});

</script>
</head>

<body>
    <h1 id="pageTitle"></h1>
    <a id="homeButton" class="button" href="#home">Home</a>
    <a class="button" href="#searchForm">Search</a>

    <ul id="home" title="Home" selected="true">
        <li><a id="getCurrent" href="#current">Current Played File</a></li>
        <li><a href="#search">Search</a></li>
        <li><a href="#options">Options</a></li>
        <li><a href="getcurrent.html">Normal link</a></li>
        <li><a href="#test">Test</a></li>
    </ul>

    <div id="current" class="panel" title="Current">
    	<table id="playControls" width="100%">
			<tr>
				<td>
					<a href="?prev">
						<img src="images/prev.gif" width="24" height="24" border="0" alt="jump to previous song">
					</a>
				</td>
				<td>
					<a href="?play">
						<img src="images/play.gif" width="24" height="24" border="0" alt="start playback">
					</a>
				</td>
				<td>
					<a href="?stop">
						<img src="images/stop.gif" width="24" height="24" border="0" alt="stop playback">
					</a>
				</td>
				<td>
					<a href="?pause">
						<img src="images/pause.gif" width="24" height="24" border="0" alt="pause playback">
					</a>
				</td>
				<td>
					<a href="?next">
						<img src="images/next.gif" width="24" height="24" border="0" alt="jump to next song">
					</a>
				</td>
			</tr>
		</table>

        <ul>
			<li><a href="#searchResults" id="currentAlbum">Album: <img src="images/loading.gif" width="20" /></a></li>
			<li><a href="#searchResults" id="currentArtist">Artist: <img src="images/loading.gif" width="20" /></a></li>
			<li id="currentTitle">Title: <img src="images/loading.gif" width="20" /></li>
			<li id="currentInfo">Info: <img src="images/loading.gif" width="20" /></li>
		</ul>
		<img id="currentAlbumArt" src="images/loading.gif" width="100" />
    </div>

    <div id="test" class="panel" title="Belle & Sebastian">
		<h2>Normal list</h2>
		<ul>
			<li>About</li>
			<li>Blog</li>
		</ul>
		<h2>Link List:</h2>
		<ul>
			<li><a href="#consulting-clinic.html">Consulting Clinic</a></li>
			<li><a href="#on-call.html">On Call</a></li>
			<li><a href="#development.html">Development</a></li>
		</ul>
		<h2>About</h2>
		<p>Jonathan Stark is a web developer, speaker, and author. His
		   consulting firm, Jonathan Stark Consulting, Inc., has attracted
		   clients such as Staples, Turner Broadcasting, and the PGA Tour.
		   ...
		</p>
		<p>Jonathan Stark is a mobile and web application developer who the
		   Wall Street Journal has called an expert on publishing desktop
		   data to the web.</p>
		<ul>
			<li><a href="#services.html">Services</a></li>
			<li><a href="#about.html">About</a></li>
			<li><a href="#blog.html">Blog</a></li>
		</ul>
    </div>

    <div id="options" class="panel" title="Options">
		<h2>Basic options</h2>
        <ul>
			<li>dsfg</li>
			<li>sdfars</li>
			<li>ds ase rtg fg</li>
			<li>araw</li>
		</ul>
	</div>

    <div id="search" class="panel" title="Search">
		<ul>
			<li><a href="#searchQuery">Search by Query</a></li>
			<li>Other option</li>
			<li>Other option</li>
		</ul>
    </div>

    <div id="searchResults" class="panel" title="Search">
		<h2>Search Results</h2>
		<ul id="searchList">
			<li><img src="images/loading.gif" width="24"></li>
		</ul>
    </div>

    <form id="searchForm" class="dialog" action="#searchResults">
        <fieldset>
            <h1>Music Search</h1>
            <!-- Fire the onSubmit event -->
            <a class="button toolButton goButton" href="javascript:void(0)" onclick="$(this).getParent().getParent().fireEvent('submit',event)">Search</a>

            <label>Artist:</label>
            <input type="text" name="artist" />
            <label>Song:</label>
            <input type="text" name="song" />
        </fieldset>
    </form>
</body>
</html>
